<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Yichen Qin">

<title>BANA7046 Module 6: Classification and Regression Trees</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="module6_files/libs/clipboard/clipboard.min.js"></script>
<script src="module6_files/libs/quarto-html/quarto.js" type="module"></script>
<script src="module6_files/libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="module6_files/libs/quarto-html/popper.min.js"></script>
<script src="module6_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="module6_files/libs/quarto-html/anchor.min.js"></script>
<link href="module6_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="module6_files/libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="module6_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="module6_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="module6_files/libs/bootstrap/bootstrap-bb462d781dde1847d9e3ccf7736099dd.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">


</head>

<body class="fullcontent quarto-light">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">BANA7046 Module 6: Classification and Regression Trees</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Yichen Qin </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<section id="tree-models" class="level1">
<h1>1. Tree Models</h1>
<section id="type-of-trees" class="level2">
<h2 class="anchored" data-anchor-id="type-of-trees">1.1. Type of Trees</h2>
<p>There are two type of tree models, designed for different types of response variable.</p>
<ul>
<li><p>Classification tree: response variable Y is category.</p></li>
<li><p>Regression tree: response variable Y is numeric.</p></li>
</ul>
<p>In this course, we have used the following data sets and its associates machine learning methods.</p>
<p>iris: knn, kmeans.</p>
<p>Boston housing: linear regression, LASSO, ridge regression, <strong>regression tree</strong>.</p>
<p>German credit, bankruptcy, credit card: logistic regression, <strong>classification tree</strong>.</p>
</section>
<section id="classification-trees" class="level2">
<h2 class="anchored" data-anchor-id="classification-trees">1.2. Classification Trees</h2>
<section id="example" class="level3">
<h3 class="anchored" data-anchor-id="example">1.2.1. Example</h3>
<p>Let’s look at a simple example, beer preference.</p>
<p>Hacker Pschorr is one of the oldest beer brewing companies in Munich. It collects data on customers’ beer preference (light/regular) and their demographic information. Its goal is to determine demographic factors for preferring light beer. For simplicity, let’s first focus on only two predictors income and age.</p>
<p>This is essentially a classification problem (binary: light or regular) using two predictors (income and age). Below is a snapshot of the data.</p>
<p><img src="image/beer.png" class="img-fluid" width="458"></p>
<p>Let’s try to find the relationship between the response variable, beer preference (i.e., light/regular), and the predictors (income and age).</p>
<p>Since there are only two predictors, we can visualize the data using a scatter plot with the symbol shape representing the label.</p>
<p>Based on the scatterplot, we can recursively separate the records into subgroups by creating splits, i.e., thresholds, on the predictors. This splitting of the data set can be visualized as trees.</p>
<p><img src="image/split_1.png" class="img-fluid"></p>
<p>After the first split, we can further split using another predictor.</p>
<p><img src="image/split_2.png" class="img-fluid"></p>
<p>Finally, after three splits, we essentially divide the xy-plane into for different regions.</p>
<p><img src="image/split_all.png" class="img-fluid"></p>
<p>There are still some questions. For example, how to choose the split variable and its value? When should we stop growing the tree? What rule do we use for classification/prediction in the end nodes? How do we classify a new record? Below we answer these questions one by one.</p>
</section>
<section id="determining-the-best-splits" class="level3">
<h3 class="anchored" data-anchor-id="determining-the-best-splits">1.2.2. Determining the Best Splits</h3>
<p>What do we mean by “best”?</p>
<ul>
<li><p>We want to find the split that best discriminates between records of different classes.</p></li>
<li><p>After the split we want the new sub-nodes to be more homogenous or purer than their parents nodes.</p></li>
<li><p>Therefore, we need a measure of homogeneity/purity!</p></li>
</ul>
<p>There are two commonly used measures for homogeneity:</p>
<ul>
<li><p>Entropy</p></li>
<li><p>Gini index</p></li>
</ul>
<p>Definitions are beyond the scope of this course.</p>
<p>The classification and regression trees (CART) algorithm evaluates all possible binary splits.</p>
<p>For each variable, each possible split value is tried.</p>
<ul>
<li><p>Calculate the impurity of the resulting sub-nodes.</p></li>
<li><p>Summarize the impurity of the split as the weighted average of the impurities of the sub-nodes</p></li>
</ul>
<p>Select the best variable-value split.</p>
<p>Below is an example of searching for the best split value for the income variable.</p>
<p><img src="image/split_income.png" class="img-fluid" width="515"></p>
</section>
<section id="when-to-stop-growing-trees" class="level3">
<h3 class="anchored" data-anchor-id="when-to-stop-growing-trees">1.2.2. When to Stop Growing Trees?</h3>
<p>One option is to stop when we can no longer find a split that improves the impurity measures.</p>
<p>There is a chance of overfitting if we keep splitting the data until we only have very few points at each node</p>
<p>The goal is to arrive at a tree that captures the patterns but not the noise in the training data, therefore maximizing the prediction accuracy on new data</p>
<p><img src="image/tree_stop.png" class="img-fluid"></p>
<p>We can set up different stopping rules to avoid overfitting.</p>
<ul>
<li><p>Set a minimum number of records at a node.</p></li>
<li><p>Set a maximum number of splits.</p></li>
<li><p>Statistical significance of the split.</p></li>
</ul>
<p>There is no simple good way to determine the right stopping point (depends on the dataset)</p>
<p>Instead of stopping rules, we can use pruning to avoid overfitting.</p>
<p>Pruning refers to using the validation sample to prune back (cut branches off) the full grown tree.</p>
<p>Pruning has been proven more successful in practice than stopping rules</p>
<p>Note, pruning uses the validation sample to select the best tree: the performance of the pruned tree on the validation data is not fully reflective of the performance on completely new data.</p>
<p><img src="image/tree_prune.png" class="img-fluid"></p>
</section>
<section id="prediction" class="level3">
<h3 class="anchored" data-anchor-id="prediction">1.2.3. Prediction</h3>
<p>To use the tree models to make prediction for a new observation, we simply need to “walk” down the tree using this observation’s predictors and find the end node that this observation falls into, and use the end node’s class to predict for this observation.</p>
<p>However, we need to assign a predicted class for each end node.</p>
<p>The default to assign a class to end node is the majority vote.</p>
<p>In the 2-class case: majority vote corresponds to setting the cutoff to 0.5</p>
<p>Changing the cutoff will change the labeling</p>
<p>Now, let us decide how to classify a 40 year old person with $40,000 in annual income.</p>
<p><img src="image/tree_predict.png" class="img-fluid" width="358"></p>
<p>Converting a Tree into Rules</p>
<p>We can translate the tree into decision rules</p>
<p>If Income is less than or equal to $38,562 and Age &lt;37.5 then we predict the person to like light beer.</p>
<p>If Income is less than or equal to $38,562 and Age is greater than 37.5 then we predict the person to prefer regular beer.</p>
<p>Classification and Regression Trees</p>
<p>Highly Interpretable</p>
<p>Supervised learning</p>
<p>Nonlinear</p>
<p>R: rpart (recursively partitioning trees)</p>
</section>
</section>
<section id="regression-tree" class="level2">
<h2 class="anchored" data-anchor-id="regression-tree">1.3. Regression Tree</h2>
<p>The regression tree is very similar to classification tree.</p>
<p>The only differences are</p>
<ul>
<li><p>purity measure in each node. For example, variance.</p></li>
<li><p>At each end node, we need to assign a predicted value, which is often the mean of the response variable of the training observations falling into this end node.</p></li>
</ul>
</section>
</section>
<section id="classification-credit-card-data" class="level1">
<h1>2. Classification: Credit Card Data</h1>
<section id="building-trees" class="level2">
<h2 class="anchored" data-anchor-id="building-trees">2.1. Building Trees</h2>
<p>The classification trees is slightly more complicated to specify. What makes it more complicated is that we often have asymmetric cost function. In the credit scoring case it means that false negatives (predicting 0 when truth is 1, or giving out loans that end up in default) will cost more than false positives (predicting 1 when truth is 0, rejecting loans that you should not reject).</p>
<p>Here we make the assumption that false negative cost 5 times of false positive. In real life the cost structure should be carefully researched.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rpart)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rpart.plot)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──
✔ dplyr     1.1.4     ✔ readr     2.1.6
✔ forcats   1.0.1     ✔ stringr   1.5.2
✔ ggplot2   4.0.1     ✔ tibble    3.3.1
✔ lubridate 1.9.4     ✔ tidyr     1.3.2
✔ purrr     1.2.1     
── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──
✖ dplyr::filter() masks stats::filter()
✖ dplyr::lag()    masks stats::lag()
ℹ Use the conflicted package (&lt;http://conflicted.r-lib.org/&gt;) to force all conflicts to become errors</code></pre>
</div>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>credit_data <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="at">file =</span> <span class="st">"data/credit_default.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Rows: 30000 Columns: 24
── Column specification ────────────────────────────────────────────────────────
Delimiter: ","
dbl (24): LIMIT_BAL, SEX, EDUCATION, MARRIAGE, AGE, PAY_0, PAY_2, PAY_3, PAY...

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># convert categorical data to factor</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>credit_data<span class="sc">$</span>SEX<span class="ot">&lt;-</span> <span class="fu">as.factor</span>(credit_data<span class="sc">$</span>SEX)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>credit_data<span class="sc">$</span>EDUCATION<span class="ot">&lt;-</span> <span class="fu">as.factor</span>(credit_data<span class="sc">$</span>EDUCATION)</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>credit_data<span class="sc">$</span>MARRIAGE<span class="ot">&lt;-</span> <span class="fu">as.factor</span>(credit_data<span class="sc">$</span>MARRIAGE)</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>index <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">nrow</span>(credit_data),</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>                <span class="fu">nrow</span>(credit_data)<span class="sc">*</span><span class="fl">0.80</span>)</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>credit_train <span class="ot">=</span> credit_data[index,]</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>credit_test <span class="ot">=</span> credit_data[<span class="sc">-</span>index,]</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>credit_rpart_sym <span class="ot">&lt;-</span> <span class="fu">rpart</span>(<span class="at">formula =</span> default <span class="sc">~</span> ., </span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>                       <span class="at">data =</span> credit_train, </span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>                       <span class="at">method =</span> <span class="st">"class"</span>)</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>credit_rpart_sym</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>n= 24000 

node), split, n, loss, yval, (yprob)
      * denotes terminal node

1) root 24000 5310 0 (0.7787500 0.2212500)  
  2) PAY_0&lt; 1.5 21490 3557 0 (0.8344812 0.1655188) *
  3) PAY_0&gt;=1.5 2510  757 1 (0.3015936 0.6984064) *</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>pred_sym <span class="ot">&lt;-</span> <span class="fu">predict</span>(credit_rpart_sym, <span class="at">type=</span><span class="st">"class"</span>)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(credit_train<span class="sc">$</span>default, </span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>      pred_sym, </span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>      <span class="at">dnn =</span> <span class="fu">c</span>(<span class="st">"True"</span>, <span class="st">"Pred"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    Pred
True     0     1
   0 17933   757
   1  3557  1753</code></pre>
</div>
</div>
<p>However, this tree with default cost minimizes the symmetric cost, which is misclassification rate. We can take a look at the confusion matrix.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>credit_rpart <span class="ot">&lt;-</span> <span class="fu">rpart</span>(<span class="at">formula =</span> default <span class="sc">~</span> ., </span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>                      <span class="at">data =</span> credit_train, </span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>                      <span class="at">method =</span> <span class="st">"class"</span>, </span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>                      <span class="at">parms =</span> <span class="fu">list</span>(<span class="at">loss=</span><span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">5</span>,<span class="dv">1</span>,<span class="dv">0</span>), <span class="at">nrow =</span> <span class="dv">2</span>)))</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>credit_rpart</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>n= 24000 

node), split, n, loss, yval, (yprob)
      * denotes terminal node

1) root 24000 18690 1 (0.77875000 0.22125000)  
  2) PAY_0&lt; 0.5 18517 12815 0 (0.86158665 0.13841335)  
    4) PAY_AMT2&gt;=1500.5 12228  6565 0 (0.89262349 0.10737651)  
      8) PAY_4&lt; 1 11580  5680 0 (0.90189983 0.09810017) *
      9) PAY_4&gt;=1 648   471 1 (0.72685185 0.27314815) *
    5) PAY_AMT2&lt; 1500.5 6289  5039 1 (0.80124026 0.19875974) *
  3) PAY_0&gt;=0.5 5483  2736 1 (0.49899690 0.50100310) *</code></pre>
</div>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>credit_rpart</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>n= 24000 

node), split, n, loss, yval, (yprob)
      * denotes terminal node

1) root 24000 18690 1 (0.77875000 0.22125000)  
  2) PAY_0&lt; 0.5 18517 12815 0 (0.86158665 0.13841335)  
    4) PAY_AMT2&gt;=1500.5 12228  6565 0 (0.89262349 0.10737651)  
      8) PAY_4&lt; 1 11580  5680 0 (0.90189983 0.09810017) *
      9) PAY_4&gt;=1 648   471 1 (0.72685185 0.27314815) *
    5) PAY_AMT2&lt; 1500.5 6289  5039 1 (0.80124026 0.19875974) *
  3) PAY_0&gt;=0.5 5483  2736 1 (0.49899690 0.50100310) *</code></pre>
</div>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">prp</span>(credit_rpart, <span class="at">extra =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="module6_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(credit_rpart, <span class="at">type=</span><span class="st">"class"</span>)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(credit_train<span class="sc">$</span>default, </span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>      pred, </span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>      <span class="at">dnn =</span> <span class="fu">c</span>(<span class="st">"True"</span>, <span class="st">"Pred"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    Pred
True     0     1
   0 10444  8246
   1  1136  4174</code></pre>
</div>
</div>
<p>The parms argument is a list. The most import element is the loss matrix. The diagonal elements are 0, and off-diagonal elements tells you the loss (cost) of classifying something wrong. For binary classification, the numbers in c() specify the cost in this sequence: c(0, False Negative, False Positive, 0). If you have symmetric cost, you can ignore the parms argument.</p>
</section>
<section id="prediction-1" class="level2">
<h2 class="anchored" data-anchor-id="prediction-1">2.2. Prediction</h2>
<p>There are 2 types of predictions, the probability and the actual predicted response. We use an additional argument type=“class” or type=“prob” to obtain these.</p>
<p>We first generate a predicted response, i.e., 0 or 1.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>credit_train_pred_tree <span class="ot">=</span> </span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">predict</span>(credit_rpart, </span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>          credit_train, </span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>          <span class="at">type=</span><span class="st">"class"</span>)</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>credit_test_pred_tree <span class="ot">=</span> </span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">predict</span>(credit_rpart, </span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>          credit_test, </span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>          <span class="at">type=</span><span class="st">"class"</span>)</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(credit_train<span class="sc">$</span>default, </span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>      credit_train_pred_tree, </span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>      <span class="at">dnn=</span><span class="fu">c</span>(<span class="st">"Truth"</span>,<span class="st">"Predicted"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     Predicted
Truth     0     1
    0 10444  8246
    1  1136  4174</code></pre>
</div>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(credit_test<span class="sc">$</span>default, </span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>      credit_test_pred_tree, </span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>      <span class="at">dnn=</span><span class="fu">c</span>(<span class="st">"Truth"</span>,<span class="st">"Predicted"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     Predicted
Truth    0    1
    0 2595 2079
    1  316 1010</code></pre>
</div>
</div>
<p>We can alternatively generate the predicted probabilities, i.e., between 0 and 1.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>credit_train_prob_tree <span class="ot">=</span> </span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">predict</span>(credit_rpart, </span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>          credit_test, </span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>          <span class="at">type=</span><span class="st">"prob"</span>)</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>credit_test_prob_tree <span class="ot">=</span> </span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">predict</span>(credit_rpart, </span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>          credit_test, </span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>          <span class="at">type=</span><span class="st">"prob"</span>)</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>cost <span class="ot">&lt;-</span> <span class="cf">function</span>(r, phat){</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>  weight1 <span class="ot">&lt;-</span> <span class="dv">5</span></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>  weight0 <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>  pcut <span class="ot">&lt;-</span> weight0<span class="sc">/</span>(weight1<span class="sc">+</span>weight0) </span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>  c1 <span class="ot">&lt;-</span> (r<span class="sc">==</span><span class="dv">1</span>)<span class="sc">&amp;</span>(phat<span class="sc">&lt;</span>pcut) <span class="co">#logical vector - true if actual 1 but predict 0</span></span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>  c0 <span class="ot">&lt;-</span>(r<span class="sc">==</span><span class="dv">0</span>)<span class="sc">&amp;</span>(phat<span class="sc">&gt;</span>pcut) <span class="co">#logical vector - true if actual 0 but predict 1</span></span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">mean</span>(weight1<span class="sc">*</span>c1<span class="sc">+</span>weight0<span class="sc">*</span>c0))</span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a><span class="fu">cost</span>(credit_train<span class="sc">$</span>default, </span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>     credit_train_prob_tree[,<span class="dv">2</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.9400833</code></pre>
</div>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cost</span>(credit_test<span class="sc">$</span>default,  </span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>     credit_test_prob_tree[,<span class="dv">2</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.6098333</code></pre>
</div>
</div>
</section>
<section id="comparison-to-logistic-regressions" class="level2">
<h2 class="anchored" data-anchor-id="comparison-to-logistic-regressions">2.3. Comparison to Logistic Regressions</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Fit logistic regression model</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>credit_glm <span class="ot">&lt;-</span> <span class="fu">glm</span>(default<span class="sc">~</span>., </span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>                  <span class="at">data =</span> credit_train, </span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>                  <span class="at">family=</span>binomial)</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="co">#Get binary prediction</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>credit_test_prob_glm <span class="ot">&lt;-</span> <span class="fu">predict</span>(credit_glm, </span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>                                credit_test, </span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>                                <span class="at">type=</span><span class="st">"response"</span>)</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a><span class="co">#Calculate cost using test set</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a><span class="fu">cost</span>(credit_test<span class="sc">$</span>default, </span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>     credit_test_prob_glm)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.6745</code></pre>
</div>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(credit_test<span class="sc">$</span>default, </span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>      (credit_test_prob_glm<span class="sc">&gt;</span><span class="dv">1</span><span class="sc">/</span><span class="dv">6</span>)<span class="sc">*</span><span class="dv">1</span>, </span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>      <span class="at">dnn=</span><span class="fu">c</span>(<span class="st">"Truth"</span>,<span class="st">"Predicted"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     Predicted
Truth    0    1
    0 2107 2567
    1  296 1030</code></pre>
</div>
</div>
</section>
<section id="roc-and-auc" class="level2">
<h2 class="anchored" data-anchor-id="roc-and-auc">2.4. ROC and AUC</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>credit_rpart <span class="ot">&lt;-</span> <span class="fu">rpart</span>(<span class="at">formula =</span> default <span class="sc">~</span> .,</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>                      <span class="at">data =</span> credit_train, </span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>                      <span class="at">method =</span> <span class="st">"class"</span>,</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>                      <span class="at">parms =</span> <span class="fu">list</span>(<span class="at">loss=</span><span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">5</span>,<span class="dv">1</span>,<span class="dv">0</span>), <span class="at">nrow =</span> <span class="dv">2</span>)))</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a><span class="co">#Probability of getting 1</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>credit_test_prob_rpart <span class="ot">=</span> <span class="fu">predict</span>(credit_rpart, </span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>                                 credit_test, </span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">type=</span><span class="st">"prob"</span>)</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a><span class="co">#install.packages('ROCR')</span></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ROCR)</span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>pred <span class="ot">=</span> <span class="fu">prediction</span>(credit_test_prob_rpart[,<span class="dv">2</span>], </span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>                  credit_test<span class="sc">$</span>default)</span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>perf <span class="ot">=</span> <span class="fu">performance</span>(pred, <span class="st">"tpr"</span>, <span class="st">"fpr"</span>)</span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(perf, <span class="at">colorize=</span><span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="module6_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>AUC on the test set is</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">slot</span>(<span class="fu">performance</span>(pred, <span class="st">"auc"</span>), <span class="st">"y.values"</span>)[[<span class="dv">1</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.7214135</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>credit_test_pred_rpart <span class="ot">=</span> <span class="dv">1</span><span class="sc">*</span>(credit_test_prob_rpart[,<span class="dv">2</span>] <span class="sc">&gt;</span> <span class="dv">1</span><span class="sc">/</span>(<span class="dv">5</span><span class="sc">+</span><span class="dv">1</span>))</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(credit_test<span class="sc">$</span>default, </span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>      credit_test_pred_rpart, </span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>      <span class="at">dnn=</span><span class="fu">c</span>(<span class="st">"Truth"</span>,<span class="st">"Predicted"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     Predicted
Truth    0    1
    0 2595 2079
    1  316 1010</code></pre>
</div>
</div>
</section>
</section>
<section id="regression-tree-boston-housing-data" class="level1">
<h1>3. Regression Tree: Boston Housing Data</h1>
<section id="building-trees-1" class="level2">
<h2 class="anchored" data-anchor-id="building-trees-1">3.1. Building Trees</h2>
<p>We first load the data and create the training and test sets.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(MASS) <span class="co">#this data is in MASS package</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'MASS'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:dplyr':

    select</code></pre>
</div>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>sample_index <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">nrow</span>(Boston),<span class="fu">nrow</span>(Boston)<span class="sc">*</span><span class="fl">0.90</span>)</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>boston_train <span class="ot">&lt;-</span> Boston[sample_index,]</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>boston_test <span class="ot">&lt;-</span> Boston[<span class="sc">-</span>sample_index,]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The tree models are impletemented in the rpart package.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co">#install.packages('rpart') </span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="co">#install.packages('rpart.plot') </span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rpart)</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rpart.plot)</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>boston_rpart <span class="ot">&lt;-</span> <span class="fu">rpart</span>(<span class="at">formula =</span> medv <span class="sc">~</span> ., </span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>                      <span class="at">data =</span> boston_train)</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>boston_rpart</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>n= 455 

node), split, n, deviance, yval
      * denotes terminal node

 1) root 455 37997.1100 22.61714  
   2) rm&lt; 6.92 387 15548.8000 20.03902  
     4) lstat&gt;=14.4 157  3022.6410 15.12102  
       8) nox&gt;=0.607 93  1260.7720 13.05269  
        16) lstat&gt;=19.645 47   417.7740 10.67234 *
        17) lstat&lt; 19.645 46   304.5993 15.48478 *
       9) nox&lt; 0.607 64   785.8848 18.12656 *
     5) lstat&lt; 14.4 230  6136.7660 23.39609  
      10) dis&gt;=1.5511 223  3167.9640 22.93767  
        20) rm&lt; 6.543 173  1256.9280 21.62543 *
        21) rm&gt;=6.543 50   582.4058 27.47800 *
      11) dis&lt; 1.5511 7  1429.0200 38.00000 *
   3) rm&gt;=6.92 68  5236.7030 37.28971  
     6) rm&lt; 7.437 43  1819.2670 32.25349  
      12) lstat&gt;=9.1 7   484.1971 23.45714 *
      13) lstat&lt; 9.1 36   688.1231 33.96389 *
     7) rm&gt;=7.437 25   450.9224 45.95200 *</code></pre>
</div>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="fu">prp</span>(boston_rpart,<span class="at">digits =</span> <span class="dv">4</span>, <span class="at">extra =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="module6_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>What is the predicted median housing price (in thousand) given following information:</p>
<table class="caption-top table">
<colgroup>
<col style="width: 7%">
<col style="width: 7%">
<col style="width: 7%">
<col style="width: 7%">
<col style="width: 7%">
<col style="width: 7%">
<col style="width: 7%">
<col style="width: 7%">
<col style="width: 7%">
<col style="width: 7%">
<col style="width: 7%">
<col style="width: 7%">
<col style="width: 7%">
<col style="width: 7%">
</colgroup>
<thead>
<tr class="header">
<th>crim</th>
<th>zn</th>
<th>indus</th>
<th>chas</th>
<th>nox</th>
<th>rm</th>
<th>age</th>
<th>dis</th>
<th>rad</th>
<th>tax</th>
<th>ptratio</th>
<th>black</th>
<th>lstat</th>
<th>medv</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0.09</td>
<td>0</td>
<td>25.65</td>
<td>0</td>
<td>0.58</td>
<td>5.96</td>
<td>92.9</td>
<td>2.09</td>
<td>2</td>
<td>188</td>
<td>19.1</td>
<td>378.09</td>
<td>17.93</td>
<td>20.5</td>
</tr>
</tbody>
</table>
</section>
<section id="prediction-using-trees" class="level2">
<h2 class="anchored" data-anchor-id="prediction-using-trees">3.2. Prediction using Trees</h2>
<p>We calculate the in-sample and out-of-sample prediction errors.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>boston_train_pred_tree <span class="ot">=</span> <span class="fu">predict</span>(boston_rpart,</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>                                 boston_train)</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>boston_test_pred_tree <span class="ot">=</span> <span class="fu">predict</span>(boston_rpart,</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>                                boston_test)</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>((boston_train_pred_tree <span class="sc">-</span> boston_train<span class="sc">$</span>medv)<span class="sc">^</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 14.06561</code></pre>
</div>
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>((boston_test_pred_tree <span class="sc">-</span> boston_test<span class="sc">$</span>medv)<span class="sc">^</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 27.43894</code></pre>
</div>
</div>
<p>We compare the MSE with that of linear regression below.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>boston_reg <span class="ot">=</span> <span class="fu">lm</span>(medv <span class="sc">~</span> ., </span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>                <span class="at">data =</span> boston_train)</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>boston_test_pred_reg <span class="ot">=</span> <span class="fu">predict</span>(boston_reg,</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>                               boston_test)</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>((boston_test_pred_reg <span class="sc">-</span> boston_test<span class="sc">$</span>medv)<span class="sc">^</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 20.04389</code></pre>
</div>
</div>
</section>
<section id="pruning" class="level2">
<h2 class="anchored" data-anchor-id="pruning">3.3. Pruning</h2>
<p>In rpart(), the cp (complexity parameter) argument is one of the parameters that are used to control the complexity of the tree. The help document for rpart tells you ‘’Any split that does not decrease the overall lack of fit by a factor of cp is not attempted.’’ For a regression tree, the overall R-square must increase by cp at each step. Basically, the smaller the cp value, the larger (complex) tree rpart will attempt to fit. The default value for cp is 0.01.</p>
<p>What happens when you have a large tree? The following tree has 27 splits.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>boston_largetree <span class="ot">&lt;-</span> <span class="fu">rpart</span>(<span class="at">formula =</span> medv <span class="sc">~</span> ., </span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>                          <span class="at">data =</span> boston_train, </span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>                          <span class="at">cp =</span> <span class="fl">0.001</span>)</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a><span class="fu">prp</span>(boston_largetree)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="module6_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plotcp</span>(boston_largetree)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="module6_files/figure-html/unnamed-chunk-14-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>You can observe from the above graph that the cross-validation error (x-val) does not always go down when the tree becomes more complex. The analogy is when you add more variables in a regression model, its ability to predict future observations not necessarily increases.</p>
<p>A good choice of cp for pruning is often the leftmost value for which the mean lies below the horizontal line. In the Boston housing example, you may conclude that having a tree mode with more than 10 splits is not helpful.</p>
<p>To look at the error vs size of tree more carefully, you can look at the following table:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="fu">printcp</span>(boston_largetree)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Regression tree:
rpart(formula = medv ~ ., data = boston_train, cp = 0.001)

Variables actually used in tree construction:
[1] age     crim    dis     lstat   nox     ptratio rm      tax    

Root node error: 37997/455 = 83.51

n= 455 

          CP nsplit rel error  xerror     xstd
1  0.4529714      0   1.00000 1.00134 0.087657
2  0.1681547      1   0.54703 0.63290 0.063201
3  0.0780721      2   0.37887 0.45026 0.053812
4  0.0405237      3   0.30080 0.35333 0.045770
5  0.0349666      4   0.26028 0.37327 0.048376
6  0.0256857      5   0.22531 0.33746 0.045331
7  0.0170262      6   0.19963 0.31371 0.045342
8  0.0141695      7   0.18260 0.31460 0.049309
9  0.0074557      8   0.16843 0.30360 0.048236
10 0.0055721      9   0.16097 0.30537 0.049582
11 0.0054046     10   0.15540 0.30477 0.049615
12 0.0045461     11   0.15000 0.30412 0.049698
13 0.0043672     12   0.14545 0.29410 0.046345
14 0.0031674     13   0.14108 0.28724 0.045990
15 0.0031580     14   0.13792 0.28288 0.045964
16 0.0028801     15   0.13476 0.28212 0.045969
17 0.0021613     16   0.13188 0.27518 0.045602
18 0.0018053     18   0.12756 0.27661 0.045620
19 0.0013248     19   0.12575 0.27731 0.045565
20 0.0012893     20   0.12443 0.27849 0.045425
21 0.0012067     21   0.12314 0.27950 0.045419
22 0.0011849     22   0.12193 0.28166 0.046914
23 0.0011483     23   0.12075 0.28280 0.047171
24 0.0011406     24   0.11960 0.28297 0.047168
25 0.0011399     25   0.11846 0.28258 0.047171
26 0.0010270     27   0.11618 0.28306 0.047186
27 0.0010078     28   0.11515 0.28500 0.047206
28 0.0010000     29   0.11414 0.28503 0.047209</code></pre>
</div>
</div>
<p>Root node error is the error when you use the sample mean for prediction. In regression case, it is the average (mean) squared error (MSE) if you use the average of medv as the prediction. Note it is the same as</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>((boston_train<span class="sc">$</span>medv <span class="sc">-</span> <span class="fu">mean</span>(boston_train<span class="sc">$</span>medv))<span class="sc">^</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 83.51012</code></pre>
</div>
</div>
<p>The first 2 columns CP and nsplit tells you how large the tree is. The rel.error × root node error gives you the in sample error.</p>
<p>xerror gives you the cross-validation (default is 10-fold) error. You can see that the rel error (in-sample error) is always decreasing as model is more complex, while the cross-validation error (measure of performance on future observations) is not. That is why we prune the tree to avoid overfitting the training data.</p>
<p>The way rpart() does it is that it uses some default control parameters to avoid fitting a large tree. The main reason for this approach is to save computation time. For example by default rpart set a cp = 0.01 and the minimum number of observations that must exist in a node to be 20. Use ?rpart.control to view these parameters. Sometimes we wish to change these parameters to see how more complex trees will perform, as we did above. If we have a larger than necessary tree, we can use prune() function and specify a new cp:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>boston_pruned_tree <span class="ot">=</span> <span class="fu">prune</span>(boston_largetree, <span class="at">cp =</span> <span class="fl">0.008</span>)</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>boston_pruned_tree</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>n= 455 

node), split, n, deviance, yval
      * denotes terminal node

 1) root 455 37997.1100 22.61714  
   2) rm&lt; 6.92 387 15548.8000 20.03902  
     4) lstat&gt;=14.4 157  3022.6410 15.12102  
       8) nox&gt;=0.607 93  1260.7720 13.05269  
        16) lstat&gt;=19.645 47   417.7740 10.67234 *
        17) lstat&lt; 19.645 46   304.5993 15.48478 *
       9) nox&lt; 0.607 64   785.8848 18.12656 *
     5) lstat&lt; 14.4 230  6136.7660 23.39609  
      10) dis&gt;=1.5511 223  3167.9640 22.93767  
        20) rm&lt; 6.543 173  1256.9280 21.62543 *
        21) rm&gt;=6.543 50   582.4058 27.47800 *
      11) dis&lt; 1.5511 7  1429.0200 38.00000 *
   3) rm&gt;=6.92 68  5236.7030 37.28971  
     6) rm&lt; 7.437 43  1819.2670 32.25349  
      12) lstat&gt;=9.1 7   484.1971 23.45714 *
      13) lstat&lt; 9.1 36   688.1231 33.96389 *
     7) rm&gt;=7.437 25   450.9224 45.95200 *</code></pre>
</div>
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="fu">prp</span>(boston_pruned_tree)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="module6_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p><strong>Exercise:</strong> Prune a classification tree. Start with cp=0.001 and find a reasonable cp value, then obtain the pruned tree.</p>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>